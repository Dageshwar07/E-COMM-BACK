name: Deploy e-comm-back to EC2

on:
  push:
    branches:
      - master

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Code
        uses: actions/checkout@v3

      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.EC2_SSH_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H ${{ secrets.EC2_HOST }} >> ~/.ssh/known_hosts

      - name: Debug Secret Presence
        run: |
          echo "Checking secret lengths..."
          echo "DEV_MODE: ${#DEV_MODE}"
          echo "PORT: ${#PORT}"
          echo "JWT_SECRET: ${#JWT_SECRET}"
          echo "MONGO_URL: ${#MONGO_URL}"
        env:
          DEV_MODE: ${{ secrets.DEV_MODE }}
          PORT: ${{ secrets.PORT }}
          JWT_SECRET: ${{ secrets.JWT_SECRET }}
          MONGO_URL: ${{ secrets.MONGO_URL }}

      - name: SSH & Deploy Docker Container
        run: |
            echo "ðŸš€ Starting SSH deployment..."
            ssh -o StrictHostKeyChecking=no ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} << "EOF"

              set -e

              echo "âœ… Removing old container..."
              docker rm -f e-comm-back || true

              echo "ðŸ“¦ Pulling latest Docker image..."
              docker pull dageshwar07/e-comm-back:v2

              echo "ðŸš€ Running Docker container..."
              docker run -d --name e-comm-back -p 4000:4000 \
                -e NODE_ENV=production \
                -e PORT=4000 \
                -e JWT_SECRET=dageshwardasmanikpuri9669712991 \
                -e MONGO_URL="mongodb+srv://Dageshwar07:Dagesh0712@cluster1.o9ihroc.mongodb.net/ecommerce?retryWrites=true&w=majority" \
                -e BRAINTREE_PUBLIC_KEY=4y2kdfq2mdqn3f7v \
                -e BRAINTREE_PRIVATE_KEY=6d3e25dfcda2b75459b440bf6ab44be7 \
                -e BRAINTREE_MERCHANT_ID=sdq9bn8825y4n32r \
                -e BASE_URL=http://localhost:3000 \
                dageshwar07/e-comm-back:v2

              echo "âœ… Deployment finished."

            EOF
